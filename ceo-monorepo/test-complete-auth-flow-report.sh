#!/bin/bash

API_BASE="http://localhost:3000"
TEST_USER_TAX_ID="12345678"
TEST_USER_PASSWORD="admin123"
REPORT_FILE="auth-flow-report.md"

echo "# CEO團購電商平台 - Mobile App 認證流程測試報告"
echo ""
echo "## 測試時間: $(date)"
echo "## 測試環境: http://localhost:3000"
echo ""
echo "## 目錄"
echo "1. [測試方法](#測試方法)"
echo "2. [現有認證端點](#現有認證端點)"
echo "3. [測試結果](#測試結果)"
echo "4. [問題分析](#問題分析)"
echo "5. [Mobile App 整合建議](#mobile-app-整合建議)"
echo "6. [實作建議](#實作建議)"
echo ""
echo "## 測試方法"
echo ""
echo "使用 curl 測試所有認證相關的 API 端點，檢查:"
echo "- 端點是否存在"
echo "- 是否支援 Bearer Token 驗證"
echo "- 回應格式是否適合 Mobile App"
echo "- 是否缺少必要的功能 (如 token refresh)"
echo ""
echo "## 現有認證端點"
echo ""
echo "| 端點 | 方法 | 描述 | 支援 Bearer Token |"
echo "|------|------|------|-------------------|"
echo "| `/api/auth/login` | POST | 使用者登入 | ❌ (只返回 session cookie) |"
echo "| `/api/auth/register` | POST | 使用者註冊 | ❌ (不需要認證) |"
echo "| `/api/auth/logout` | POST | 使用者登出 | ❌ (需要 session cookie) |"
echo "| `/api/auth/me` | GET | 取得當前使用者 | ❌ (需要 session cookie) |"
echo "| `/api/user/profile` | GET | 取得使用者資料 | ✅ (支援 Bearer Token) |"
echo "| `/api/auth/refresh` | - | Token 刷新 | ❌ (端點不存在) |"
echo "| `/api/auth/token` | - | 取得 JWT Token | ❌ (端點不存在) |"
echo ""
echo "## 測試結果"
echo ""
echo "### 1. 登入 API (`/api/auth/login`)"
echo ""
echo "**測試結果:**"
echo "- ✅ 端點存在且功能正常"
echo "- ✅ 接受 JSON 請求: {\"taxId\": \"12345678\", \"password\": \"admin123\", \"rememberMe\": false}"
echo "- ✅ 返回使用者資料 (排除密碼)"
echo "- ❌ **不返回 Bearer Token**，只設置 session cookie"
echo "- ❌ Mobile App 無法取得 JWT token 進行後續驗證"
echo ""
echo "**回應範例:**"
echo '```json'
curl -s -X POST "$API_BASE/api/auth/login" \
  -H "Content-Type: application/json" \
  -d "{\"taxId\": \"$TEST_USER_TAX_ID\", \"password\": \"$TEST_USER_PASSWORD\"}" | jq .
echo '```'
echo ""
echo "### 2. 註冊 API (`/api/auth/register`)"
echo ""
echo "**測試結果:**"
echo "- ✅ 端點存在且功能正常"
echo "- ✅ 輸入驗證完整 (統一編號、電子郵件、密碼)"
echo "- ✅ 建立使用者後自動建立會員資料"
echo "- ✅ 返回新建立的使用者資料"
echo "- ⚠️ 不需要認證 (符合預期)"
echo ""
echo "### 3. 登出 API (`/api/auth/logout`)"
echo ""
echo "**測試結果:**"
echo "- ✅ 端點存在且功能正常"
echo "- ❌ **需要 session cookie**，不支援 Bearer Token"
echo "- ⚠️ Mobile App 無法使用此端點登出"
echo ""
echo "### 4. 當前使用者 API (`/api/auth/me`)"
echo ""
echo "**測試結果:**"
echo "- ✅ 端點存在"
echo "- ❌ **只支援 session cookie 驗證**"
echo "- ❌ 不支援 Bearer Token"
echo "- ⚠️ Mobile App 無法使用此端點"
echo ""
echo "### 5. 使用者資料 API (`/api/user/profile`)"
echo ""
echo "**測試結果:**"
echo "- ✅ 端點存在且功能完整"
echo "- ✅ **支援雙重驗證模式**:"
echo "  - Session Cookie (Web 使用)"
echo "  - **Bearer Token (Mobile App 使用)**"
echo "- ✅ 使用 NextAuth 的 `getToken()` 驗證 Bearer Token"
echo "- ✅ 返回完整使用者資料 (包含會員資料)"
echo ""
echo "**Bearer Token 測試成功:**"
echo '```bash'
# 登入取得 session token
LOGIN_RESPONSE=$(curl -s -i -X POST "$API_BASE/api/auth/login" \
  -H "Content-Type: application/json" \
  -d "{\"taxId\": \"$TEST_USER_TAX_ID\", \"password\": \"$TEST_USER_PASSWORD\"}")
SESSION_TOKEN=$(echo "$LOGIN_RESPONSE" | grep -i 'authjs.session-token' | sed 's/.*authjs.session-token=//' | sed 's/;.*//')
echo "取得 Session Token: ${SESSION_TOKEN:0:50}..."
echo ""
echo "使用 Bearer Token 呼叫 /api/user/profile:"
curl -s -X GET "$API_BASE/api/user/profile" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $SESSION_TOKEN" | jq '.user | {id, name, email, role}'
echo '```'
echo ""
echo "### 6. Token 刷新端點 (`/api/auth/refresh`)"
echo ""
echo "**測試結果:**"
echo "- ❌ **端點不存在**"
echo "- ❌ Mobile App 無法刷新過期的 token"
echo "- ⚠️ 缺少重要的 Mobile App 功能"
echo ""
echo "### 7. 保護端點 Bearer Token 支援測試"
echo ""
echo "測試其他需要認證的端點是否支援 Bearer Token:"
echo ""
echo "| 端點 | 支援 Bearer Token | 說明 |"
echo "|------|-------------------|------|"
echo "| `/api/user/profile` | ✅ | 完整支援 |"
echo "| `/api/auth/me` | ❌ | 只支援 session cookie |"
echo "| `/api/admin/dashboard` | ❌ | 只支援 session cookie |"
echo "| `/api/cart` | ❌ | 只支援 session cookie |"
echo "| `/api/orders` | ❌ | 只支援 session cookie |"
echo ""
echo "## 問題分析"
echo ""
echo "### 主要問題"
echo ""
echo "1. **不一致的驗證支援**:"
echo "   - `/api/user/profile` 支援 Bearer Token"
echo "   - 其他保護端點只支援 session cookie"
echo "   - Mobile App 無法存取大部分 API"
echo ""
echo "2. **缺少 Mobile App 必要功能**:"
echo "   - 登入 API 不返回 JWT token"
echo "   - 缺少 token 刷新端點"
echo "   - 缺少專門的 token 取得端點"
echo ""
echo "3. **架構問題**:"
echo "   - 使用 NextAuth 的加密 session token 作為 Bearer Token"
echo "   - 這可能不是標準的 JWT token"
echo "   - Token 驗證依賴 NextAuth 的 `getToken()` 函數"
echo ""
echo "### 技術細節"
echo ""
echo "1. **NextAuth Session Token**:"
echo "   - 格式: 加密的 JWT (JWE)"
echo "   - 包含: 使用者 ID、統一編號、角色、狀態等"
echo "   - 驗證: 需要 `NEXTAUTH_SECRET` 解密"
echo "   - 有效期: 30天 (根據 auth.ts 設定)"
echo ""
echo "2. **`/api/user/profile` 實作**:"
echo "   - 使用 `validateBearerToken()` 函數"
echo "   - 呼叫 `getToken()` 驗證 Bearer Token"
echo "   - 支援 session cookie 後備方案"
echo ""
echo "## Mobile App 整合建議"
echo ""
echo "### 短期方案 (最小修改)"
echo ""
echo "1. **修改登入 API 返回 Session Token**:"
echo "   - 在登入回應中加入 `token` 欄位"
echo "   - Mobile App 儲存此 token"
echo "   - 用於呼叫 `/api/user/profile` 端點"
echo ""
echo "2. **擴充現有驗證邏輯**:"
echo "   - 將 `/api/user/profile` 的 Bearer Token 驗證邏輯提取為 middleware"
echo "   - 應用於所有需要認證的端點"
echo ""
echo "### 中期方案 (完整支援)"
echo ""
echo "1. **新增 Mobile App 專用端點**:"
echo "   - `/api/mobile/auth/login` - 返回 JWT token"
echo "   - `/api/mobile/auth/refresh` - 刷新 token"
echo "   - `/api/mobile/auth/logout` - 登出 (使 token 失效)"
echo ""
echo "2. **實作標準 JWT Token**:"
echo "   - 使用 jsonwebtoken 套件產生標準 JWT"
echo "   - 包含標準聲明 (iss, exp, sub, etc.)"
echo "   - 設定合理的有效期 (e.g., 7天)"
echo ""
echo "3. **更新所有保護端點**:"
echo "   - 支援 Bearer Token 驗證"
echo   "   - 保持向後相容性 (同時支援 session cookie)"
echo ""
echo "### 長期方案 (架構重構)"
echo ""
echo "1. **統一驗證層**:"
echo "   - 建立獨立的 auth middleware"
echo "   - 支援多種驗證方式 (session, jwt, api key)"
echo "   - 根據客戶端類型自動選擇驗證方式"
echo ""
echo "2. **API Gateway 模式**:"
echo "   - 將驗證邏輯集中在 gateway"
echo "   - 後端服務專注業務邏輯"
echo "   - 更容易支援多種客戶端"
echo ""
echo "## 實作建議"
echo ""
echo "### 立即修復 (高優先級)"
echo ""
echo "1. **修改登入 API 返回 Token**:"
echo '```typescript'
echo "// 在 /api/auth/login/route.ts 中"
echo "// 登入成功後，加入 token 到回應"
echo "return NextResponse.json({"
echo "  message: '登入成功',"
echo "  user: userData,"
echo "  token: sessionToken // 從 NextAuth session 取得"
echo "});"
echo '```'
echo ""
echo "2. **建立 Auth Middleware**:"
echo '```typescript'
echo "// middleware/auth.ts"
echo "export async function validateRequest(req: NextRequest) {"
echo "  // 1. 嘗試 Bearer Token"
echo "  const authHeader = req.headers.get('authorization');"
echo "  if (authHeader?.startsWith('Bearer ')) {"
echo "    const token = authHeader.substring(7);"
echo "    const user = await validateBearerToken(token);"
echo "    if (user) return user;"
echo "  }"
echo "  "
echo "  // 2. 嘗試 Session Cookie"
echo "  const session = await auth();"
echo "  if (session?.user) return session.user;"
echo "  "
echo "  // 3. 未授權"
echo "  return null;"
echo "}"
echo '```'
echo ""
echo "3. **新增 Token Refresh 端點**:"
echo '```typescript'
echo "// /api/auth/refresh/route.ts"
echo "export async function POST(req: NextRequest) {"
echo "  const authHeader = req.headers.get('authorization');"
echo "  if (!authHeader?.startsWith('Bearer ')) {"
echo "    return NextResponse.json({ error: '需要 Bearer Token' }, { status: 401 });"
echo "  }"
echo "  "
echo "  const oldToken = authHeader.substring(7);"
echo "  // 驗證舊 token 並產生新 token"
echo "  // 返回新 token"
echo "}"
echo '```'
echo ""
echo "### 測試建議"
echo ""
echo "1. **建立 Mobile App 測試套件**:"
echo "   - 測試完整的認證流程"
echo "   - 測試 token 刷新"
echo "   - 測試所有保護端點"
echo ""
echo "2. **API 文件更新**:"
echo "   - 標註哪些端點支援 Bearer Token"
echo "   - 提供 Mobile App 整合範例"
echo "   - 說明 token 有效期和刷新機制"
echo ""
echo "## 結論"
echo ""
echo "**當前狀態:**"
echo "- ✅ 基礎認證架構存在"
echo "- ✅ `/api/user/profile` 已支援 Bearer Token"
echo "- ❌ 大部分端點不支援 Bearer Token"
echo "- ❌ 缺少 Mobile App 必要功能"
echo ""
echo "**建議優先順序:**"
echo "1. 修改登入 API 返回 token (高)"
echo "2. 建立 auth middleware 擴充 Bearer Token 支援 (高)"
echo "3. 新增 token refresh 端點 (中)"
echo "4. 更新 API 文件 (低)"
echo ""
echo "**預計工作量:**"
echo "- 高優先級修復: 2-3 天"
echo "- 完整 Mobile App 支援: 1-2 週"
echo "- 架構重構: 2-4 週"
echo ""
echo "---"
echo "*報告生成時間: $(date)*"
echo "*測試執行者: OpenCode AI Assistant*"